<!doctype html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8">
  <title>Analisando um Buffer Overflow</title>
  <meta name="generator" content="CherryTree">
  <link rel="stylesheet" href="res/styles4.css" type="text/css" />
</head>
<body>
<div class='page'><h1 class='title'>Analisando um Buffer Overflow</h1><br/><p>+ Vamos entender na prática o esquema da stack montado na aula passada</p><p><img src="images/253-1.png" alt="images/253-1.png" /></p><p></p><p>-----------------------------check.c------------------------------</p><p><div class="codebox"><pre><span style="color:#7f0044;font-weight:700">#include &lt;stdio.h&gt;</span><br /><span style="color:#7f0044;font-weight:700">#include &lt;string.h&gt;</span><br /><br /><span style="color:#7f0044;font-weight:400">int</span> main(<span style="color:#7f0044;font-weight:400">int</span> argc, <span style="color:#7f0044;font-weight:400">char</span> *argv[]){<br /><br />	<span style="color:#7f0044;font-weight:400">char</span> nome[<span style="color:#ff0044;font-weight:400">16</span>];<br />	<br />	strcpy(nome, argv[<span style="color:#ff0044;font-weight:400">1</span>]);<br />	<br />	<span style="color:#ff9d00;font-weight:700">return</span> <span style="color:#ff0044;font-weight:400">0</span>;<br /><br />}</pre></div></p><p>--------------------------------------------------------------------</p><p><ul><li>esse progarma montado em C irá apenas recebe um argumento de no máximo 16 bytes</li><li>A função strcpy pega o segundo parâmetro e associa ao primeiro, que é a variável</li></ul></p><p></p><p>+ Vamos ligar o visor de eventor do windows. Devemos limpá-lo para que possamos ver o erro acontecendo quando passamos um argumento muito grande</p><p></p><p><div class="codebox"><pre>check.exe RICARDOLONGATTO</pre></div></p><p><img src="images/253-2.png" alt="images/253-2.png" /><ul><li>Nada apareceu, então foi executado com sucesso</li></ul></p><p></p><p><div class="codebox"><pre>check.exe RICARDOLONGATTOAAAAAAAAAAAAAAA</pre></div></p><p><img src="images/253-3.png" alt="images/253-3.png" /><ul><li>Esse deslocamento de falha é o que caracteriza o buffer overflow</li></ul></p><p></p><p>+ Agora vamos começar a análise do programa no Imunnity Debugger</p><p></p><p><img src="images/253-4.png" alt="images/253-4.png" /><ul><li>Para já passar o argumento:</p><p></li></ul><img src="images/253-5.png" alt="images/253-5.png" /></p><p></p><p><img src="images/253-6.png" alt="images/253-6.png" /><ul><li>Colocamos um breakpoint na função <span style="color:#33d17a;">strcpy</span> pra que pudéssemos ver a recepção</li></ul></p><p>das variáveis setadas<ul><li>Ao apertamos o play </li></ul><img src="images/253-7.png" alt="images/253-7.png" />, o programa para no breakpoint<ul><li>Apertamos duas vezes o Fn+F7 para que ele entre na função</li><li>Analisaremos agora a stack:</p><p></li></ul><img src="images/253-8.png" alt="images/253-8.png" /><ul><li>Veja que o ESP, que aponta para o topo da stack está registrando o 0061FE80</li><li>A base da stack é o EDP: 0061FEA8</li><li>Abaixo da stack, temos o endereço de retorno: 0040113E2</p><p></li></ul><img src="images/253-9.png" alt="images/253-9.png" /><ul><li>Stack está em azul</li><li>Entre o topo e a base teremo o buffer</li><li>Se dermos um <span style="color:#33d17a;">follow in dump</span> veremos os dados setados</p><p></li></ul><img src="images/253-10.png" alt="images/253-10.png" /><ul><li>Em dest temos o destino onde será alocada a informação: 0061FE90</li><li>Buffer em azul</li><li>Agora a estrutura do começo dessaa aula está bem caracterizada</li><li>Para ver a qtd de bytes, basta clicarmos duas vezes onde cada espaço começa</li><li>Após seguirmos com o Fn+F7, chegaremos no ponto de passar todas as variáveis</li></ul></p><p>para os espaços reservados no buffer, e ele ficará no ponto de chamar o return</p><p><img src="images/253-11.png" alt="images/253-11.png" /></p><p></p><p>+ Agora passaremos um argumento maior do que o suportado: aaaaaaaaaaaaaaaabbbbbbbbbbbbbbbb</p><p><img src="images/253-12.png" alt="images/253-12.png" /><ul><li>o endereço de retorno foi também sobrescrito</li><li>Ao executarmos ele, obteremos o erro</p><p></li></ul><img src="images/253-13.png" alt="images/253-13.png" /></p><p><img src="images/253-14.png" alt="images/253-14.png" /><ul><li>O programa quebrou pois o return está apontando para o 62626262</li><li>Quanto maior o buffer alocado, maior será a stack</li><li>Uma observação é que se mudarmos o return de 0 para 5, veremos a diferença de mov eax, 0 para mov eax, 5</li></ul></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p> </p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p><p></p></div>
</body>
</html>
